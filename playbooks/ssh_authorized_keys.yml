---
- name: Manage SSH keys
  hosts: all
  remote_user: root

  vars:
    new_pubkeys:
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDddr3jqzvt7RJZaYg+NpW0iYiNtxFyk4zHQB3Y0sX6hH1xLZn3uG0LOR40dWSSbFjqORJHLHo7LeUG3iPZKvziq0CFgoN7NHVW5/v0/QEB0RYkHYr3Q82J70T9bFHMWk6gMhirsw/RU6kSxPMGK8J36R7Ggi6FSf5b4c/LA8m5WyIYVBOrf/rHi87TRvvQIbZDYO1bhwJ3L0TsR3MUNeJ87eZolerpKwquaDUl8DQ+WoW2WUUFzIpALhpNhelAdi42TB8OodpZ+uobCSCH3Zh7FuzPe0oOARS4630FJs1CGf5fLovgY4jVspgDAc071hsh0JcSHUFEzajCgpYBTCCSMEdSbSo9cl25SFY63iJoswKAN2ToBe9CD8cTWSfHmdp2bA8YX7YA0GYE5sETDeDPgud2KMq6V0hjMM4kLzIkiHB8JzSqMYaLn51nqkRFnqLuHQRv6KWeWLxVYaVfFYBF20E85vjm9izSXkgHtswLyg9FKvEeypWhX/oogncYL9U= semaphore"
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCzA4v1m28Lkm2mMranEbCX6Tr8eFmfmwHTTXpRvmDb90yS+PgkozhPy9oJYg7cuugjmDGvwpr2MFsU6axpAsfwFJyCZXtLr1VestLoNHLUZZrgn5Uwla287LRzShb0GyFE1UlkW+Uk4q0QD7G1M58f5YOO8XAxHeHwOE6/oFt+f6MG6V+EqCdwm39vYI9CXw3SHGJ249vddaOmpJNiLUShL8xZVMEEDzJ3BG6mFzq0bJnCEwBgOcxx6OnRt6/tim/AD9Iw1fWXMqdbng7SOAJ9WlCEz7ak6SqnUOEfwQpvq1M2ynxDb4xPmfRcedd6rFwips9xOnZi3c9rXgxzqctce2x6dha52rAXnJ00odJCvCN/PB2og9LIUHyPjPV8dE95LHesUGm6Hq4i3Vz08Xp02CbI/6TsqRT3aKZOxSEeAzY+aBJtxcxBEf5bZG9VpsMNO+kPKI0N4+mNRTiIfNT/jzp2Wf7Abgq8eByE3oysZnDBCN7+TYvzK6jidy4kMBHAhm18oe8EfbH9KSpe5UsRl8dwYsmC2+05JXnGB/qFkXVfHzwWPpaiXHEoRccmItqaemOOhgQ7fUR1BUlg1iYgO1peBkH+RKJCZL9Xfn2UIo1piZ42yAJuRa69obXioiAgDhodx76I6+0hL6YtmgpuzP7LdcD3sxIL2Dq2nZcQqw== yubikey"
    old_pubkeys:
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC+75NO4JOpeQuwFy/ktxX20fclGBEz0dAMw7uskr+YIYo+eQdZhjaii/w4vXPuzBu8rAHJxNY7mdtLSJ+8kh546qMTfBvzKVxxmm0BdiS7+5hmsZw0bPDyUu/Vo0wXcCoj8TIBsMNnomptak9vY2/IOopRj+z6s3RSTw/rAl8iumB1EldktknRghIgsjaVPKopqDnACJ21yh1bCqaHtt3alD3vxIPcXG+SKSlZ/bqhr8G1pUU8ho/46VtSqVvQnrEwy01TsovkI+LMN/cTZYPsYX5MNZJEzWwVp7kSko3glEj7D2Px7vbQOAsbAxqxwwivZcLUIaMHOSAfk3PLNYW+DCfsLmFvHWy/CcarzrfXY5IsnFSC7EegFJBdRHJDGy+C5wOg56yFdTtOrWYFvUbc5eKaVS09SmI7Y4wynYT7Ga0YFq0lI4oCHofKY/6Bwa3bFCEmA9t7qDYyjkvBYETlY4LE58xzHjxxt4uRNNOrtJwOjjJUNvk3lrSObyJyOjkx5bItRIeS5iF1Tn/4nP1a0gfgMClE6lVZKP855jIbrEiKwQBxI3/5I3fm5+ZtOS0BzG988hAPaP2jUVsMnkVqhhUSCk/ET/Tz7g0ygz0dgzBeOr+vWbqXeM64qBu+mAK9F09Uw9HxiNvQ4ORgJm4lC/+O9epjDxKmUcOLN2sAGw== philipp@Philipps-MBP.lan"
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCzA4v1m28Lkm2mMranEbCX6Tr8eFmfmwHTTXpRvmDb90yS+PgkozhPy9oJYg7cuugjmDGvwpr2MFsU6axpAsfwFJyCZXtLr1VestLoNHLUZZrgn5Uwla287LRzShb0GyFE1UlkW+Uk4q0QD7G1M58f5YOO8XAxHeHwOE6/oFt+f6MG6V+EqCdwm39vYI9CXw3SHGJ249vddaOmpJNiLUShL8xZVMEEDzJ3BG6mFzq0bJnCEwBgOcxx6OnRt6/tim/AD9Iw1fWXMqdbng7SOAJ9WlCEz7ak6SqnUOEfwQpvq1M2ynxDb4xPmfRcedd6rFwips9xOnZi3c9rXgxzqctce2x6dha52rAXnJ00odJCvCN/PB2og9LIUHyPjPV8dE95LHesUGm6Hq4i3Vz08Xp02CbI/6TsqRT3aKZOxSEeAzY+aBJtxcxBEf5bZG9VpsMNO+kPKI0N4+mNRTiIfNT/jzp2Wf7Abgq8eByE3oysZnDBCN7+TYvzK6jidy4kMBHAhm18oe8EfbH9KSpe5UsRl8dwYsmC2+05JXnGB/qFkXVfHzwWPpaiXHEoRccmItqaemOOhgQ7fUR1BUlg1iYgO1peBkH+RKJCZL9Xfn2UIo1piZ42yAJuRa69obXioiAgDhodx76I6+0hL6YtmgpuzP7LdcD3sxIL2Dq2nZcQqw== cardno:23_425_444"
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCzA4v1m28Lkm2mMranEbCX6Tr8eFmfmwHTTXpRvmDb90yS+PgkozhPy9oJYg7cuugjmDGvwpr2MFsU6axpAsfwFJyCZXtLr1VestLoNHLUZZrgn5Uwla287LRzShb0GyFE1UlkW+Uk4q0QD7G1M58f5YOO8XAxHeHwOE6/oFt+f6MG6V+EqCdwm39vYI9CXw3SHGJ249vddaOmpJNiLUShL8xZVMEEDzJ3BG6mFzq0bJnCEwBgOcxx6OnRt6/tim/AD9Iw1fWXMqdbng7SOAJ9WlCEz7ak6SqnUOEfwQpvq1M2ynxDb4xPmfRcedd6rFwips9xOnZi3c9rXgxzqctce2x6dha52rAXnJ00odJCvCN/PB2og9LIUHyPjPV8dE95LHesUGm6Hq4i3Vz08Xp02CbI/6TsqRT3aKZOxSEeAzY+aBJtxcxBEf5bZG9VpsMNO+kPKI0N4+mNRTiIfNT/jzp2Wf7Abgq8eByE3oysZnDBCN7+TYvzK6jidy4kMBHAhm18oe8EfbH9KSpe5UsRl8dwYsmC2+05JXnGB/qFkXVfHzwWPpaiXHEoRccmItqaemOOhgQ7fUR1BUlg1iYgO1peBkH+RKJCZL9Xfn2UIo1piZ42yAJuRa69obXioiAgDhodx76I6+0hL6YtmgpuzP7LdcD3sxIL2Dq2nZcQqw== cardno:23_815_191"

  tasks:
    - name: Add new public keys
      tags: add
      ansible.builtin.lineinfile:
        path: "/root/.ssh/authorized_keys"
        line: "{{ item }}"
        state: present
      with_items: "{{ new_pubkeys }}"

    - name: Remove old key
      tags: remove
      ansible.builtin.lineinfile:
        path: "/root/.ssh/authorized_keys"
        line: "{{ item }}"
        state: absent
      with_items: "{{ old_pubkeys }}"
